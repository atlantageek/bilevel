<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */

.arc text {
  font: 10px sans-serif;
  text-anchor: middle;
}

.arc path {
  stroke: #fff
}

</style>
<body>

<!-- load the d3.js library -->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="data.js"></script>

<script>
console.log("Loading");
let attributes = ['promoter','detractor','neutral'];

var root = d3.hierarchy(data, (d) => {return d.children});
//root.sum(function(d) {return d.size;})
root.eachAfter(function(d) {
  if (d.hasOwnProperty('children')) {
      let e = d['children'].reduce((sumchild, child) => {
        //console.log('NODE' + node);
        //console.log(child);
        result = {value:{}};
        if (sumchild == undefined) {
          console.log("Reset");
          sumchild.value={};
          attributes.forEach((e) =>{sumchild.value[e] = 0;})

        }
        if (sumchild.value == undefined) {
          console.log("Reset 2")
          sumchild.value={};
          attributes.forEach((e) =>{sumchild.value[e] = 0;});
        }
        console.log(child.data.name);
        attributes.forEach((e) =>{result.value[e] = sumchild.value[e] + child.value[e];});
        //sumchild.value['promoter'] +=child.value['promoter'];
        //sumchild.value['detractor'] +=child.value['detractor'];
        //sumchild.value['neutral'] +=child.value['neutral'];
        console.log(result.value);
        sumchild.value = result.value;
        return result
      });
      d.value = e.value;

  }
  else {
    //console.log("Leaf");
    //console.log(d);
    d.value = {'promoter': d.data.promoter, 'detractor': d.data.detractor, 'neutral': d.data.neutral};

  }
})
console.log(root);

var margin = {top: 350, right: 480, bottom: 350, left: 480},
    radius = Math.min(margin.top, margin.right, margin.bottom, margin.left) - 10;

var svg = d3.select("body").append("svg")
     .attr("width", margin.left +  margin.right )
     .attr("height", margin.top +  margin.bottom )
     .append("g")
     .attr("transform", "translate(" + margin.left + "," + margin.top + ")" );

var arc = d3.arc()
         .startAngle(function(d) { return d.x; })
         .endAngle(function(d) { return d.x + d.dx ; })
         .innerRadius(function(d) { return radius / 3 * d.depth; })
         .outerRadius(function(d) { return radius / 3 * (d.depth + 1) - 1; });

//var center = svg.append("circle").attr("r", radius/3)
  //.on("click", zoomOut)
  console.log(root);
//  let v = d3.partition(root)//.nodes//.descendants();
//  console.log(v);
var path = svg.selectAll("path").data(root)
  .enter().append("path").attr("d",arc).style("fill", function(d) { return "#cccccc"});
  //.each(function(d) { this._current = updateArc(d);})
  //.on("click", zoomIn)



</script>



</body>
